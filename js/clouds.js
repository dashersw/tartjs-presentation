(function () {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
        window.cancelRequestAnimationFrame = window[vendors[x] +
                                                    'CancelRequestAnimationFrame'];
    }

    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function (callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function () {
                    callback(currTime + timeToCall);
                },
                timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };

    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function (id) {
            clearTimeout(id);
        };
}())

var layers = [],
    objects = [],

    world = document.getElementById('world'),
    viewport = document.getElementById('viewport'),

    d = 3,
    p = 400,
    worldXAngle = 0,
    worldYAngle = 0;

viewport.style.webkitPerspective = p;
viewport.style.MozPerspective = p;
viewport.style.oPerspective = p;
var stopAnim = false;
generate();

function createCloud(cloudData, index) {

    var div = document.createElement('div');
    div.className = 'cloudBase';
    var t = cloudData;
    div.style.webkitTransform = t;
    div.style.MozTransform = t;
    div.style.oTransform = t;
    world.appendChild(div);

    var datas = [
        {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
        {"x":18.119017004966736, "y":-40.0252608537674, "z":87.37675016745925, "a":281.546319052577, "s":0.5885676103644073, "speed":0.04538736396934837},
        {"x":-71.49974801540375, "y":-9.31289417743683, "z":54.260179586708546, "a":278.52314067073166, "s":0.7696009690407664, "speed":0.05836521555902436},
        {"x":-5.884998917579651, "y":-70.61025819778443, "z":-98.95152319222689, "a":170.0833247601986, "s":1.1759401361923665, "speed":0.020143172820098698},
        {"x":-51.09917442798615, "y":-49.94196178913117, "z":72.21129820682108, "a":52.33457406051457, "s":1.0859329698141664, "speed":0.01464875164674595},
        {"x":-63.40950083732605, "y":-20.29298737049103, "z":-34.02981958352029, "a":93.39708125218749, "s":0.8438076854217798, "speed":0.010839518287684768},
        {"x":-37.23233690261841, "y":-67.09230167865753, "z":5.649509513750672, "a":333.6416985746473, "s":0.7193981246091425, "speed":0.14680025323759763},
                {"x":-73.11989448070527, "y":2.8190345287323, "z":85.58494010940194, "a":246.07536437921226, "s":0.4754853614140302, "speed":0.09058558872202412},
                {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
                {"x":18.61199817657471, "y":23.835578680038452, "z":-64.35827291570604, "a":118.3147793635726, "s":0.9796155944932252, "speed":0.11449461568845436},
                {"x":-22.095214772224427, "y":-15.608299565315248, "z":9.721252275630832, "a":150.2371311094612, "s":0.400591648183763, "speed":0.05115824168315157},
                {"x":-26.347469806671143, "y":14.884618949890138, "z":16.023369366303086, "a":328.15314933657646, "s":0.9963848264887929, "speed":0.14024699254659936},
                {"x":-5.461702299118042, "y":20.963383221626284, "z":40.82259479910135, "a":296.6026276163757, "s":0.49144390248693526, "speed":0.033465145679656416},
                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                {"x":-45.85776302814484, "y":-68.73037984371186, "z":-82.35161495395005, "a":189.4134551100433, "s":1.22332091932185, "speed":0.04733489805366844},
                {"x":-69.16765234470368, "y":-23.417467069625857, "z":89.06063251197338, "a":347.57049431093037, "s":1.1883802893571556, "speed":0.06652093537850305},
                {"x":-55.92023830413819, "y":-34.82417807579041, "z":-98.08012987487018, "a":76.73200593329966, "s":1.161880531348288, "speed":0.008419372898060828},
                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},{"x":-37.23233690261841, "y":-67.09230167865753, "z":5.649509513750672, "a":333.6416985746473, "s":0.7193981246091425, "speed":0.14680025323759763},
                        {"x":-73.11989448070527, "y":2.8190345287323, "z":85.58494010940194, "a":246.07536437921226, "s":0.4754853614140302, "speed":0.09058558872202412},
                        {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
                        {"x":18.61199817657471, "y":23.835578680038452, "z":-64.35827291570604, "a":118.3147793635726, "s":0.9796155944932252, "speed":0.11449461568845436},
                        {"x":-22.095214772224427, "y":-15.608299565315248, "z":9.721252275630832, "a":150.2371311094612, "s":0.400591648183763, "speed":0.05115824168315157},
                        {"x":-26.347469806671143, "y":14.884618949890138, "z":16.023369366303086, "a":328.15314933657646, "s":0.9963848264887929, "speed":0.14024699254659936},
                        {"x":-5.461702299118042, "y":20.963383221626284, "z":40.82259479910135, "a":296.6026276163757, "s":0.49144390248693526, "speed":0.033465145679656416},
                        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                        {"x":-45.85776302814484, "y":-68.73037984371186, "z":-82.35161495395005, "a":189.4134551100433, "s":1.22332091932185, "speed":0.04733489805366844},
                        {"x":-69.16765234470368, "y":-23.417467069625857, "z":89.06063251197338, "a":347.57049431093037, "s":1.1883802893571556, "speed":0.06652093537850305},
                        {"x":-55.92023830413819, "y":-34.82417807579041, "z":-98.08012987487018, "a":76.73200593329966, "s":1.161880531348288, "speed":0.008419372898060828},
                        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},{"x":-37.23233690261841, "y":-67.09230167865753, "z":5.649509513750672, "a":333.6416985746473, "s":0.7193981246091425, "speed":0.14680025323759763},
                                {"x":-73.11989448070527, "y":2.8190345287323, "z":85.58494010940194, "a":246.07536437921226, "s":0.4754853614140302, "speed":0.09058558872202412},
                                {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
                                {"x":18.61199817657471, "y":23.835578680038452, "z":-64.35827291570604, "a":118.3147793635726, "s":0.9796155944932252, "speed":0.11449461568845436},
                                {"x":-22.095214772224427, "y":-15.608299565315248, "z":9.721252275630832, "a":150.2371311094612, "s":0.400591648183763, "speed":0.05115824168315157},
                                {"x":-26.347469806671143, "y":14.884618949890138, "z":16.023369366303086, "a":328.15314933657646, "s":0.9963848264887929, "speed":0.14024699254659936},
                                {"x":-5.461702299118042, "y":20.963383221626284, "z":40.82259479910135, "a":296.6026276163757, "s":0.49144390248693526, "speed":0.033465145679656416},
                                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},{"x":-37.23233690261841, "y":-67.09230167865753, "z":5.649509513750672, "a":333.6416985746473, "s":0.7193981246091425, "speed":0.14680025323759763},
                                        {"x":-73.11989448070527, "y":2.8190345287323, "z":85.58494010940194, "a":246.07536437921226, "s":0.4754853614140302, "speed":0.09058558872202412},{"x":-37.23233690261841, "y":-67.09230167865753, "z":5.649509513750672, "a":333.6416985746473, "s":0.7193981246091425, "speed":0.14680025323759763},
                                                {"x":-73.11989448070527, "y":2.8190345287323, "z":85.58494010940194, "a":246.07536437921226, "s":0.4754853614140302, "speed":0.09058558872202412},
                                                {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
                                                {"x":18.61199817657471, "y":23.835578680038452, "z":-64.35827291570604, "a":118.3147793635726, "s":0.9796155944932252, "speed":0.11449461568845436},
                                                {"x":-22.095214772224427, "y":-15.608299565315248, "z":9.721252275630832, "a":150.2371311094612, "s":0.400591648183763, "speed":0.05115824168315157},
                                                {"x":-26.347469806671143, "y":14.884618949890138, "z":16.023369366303086, "a":328.15314933657646, "s":0.9963848264887929, "speed":0.14024699254659936},
                                                {"x":-5.461702299118042, "y":20.963383221626284, "z":40.82259479910135, "a":296.6026276163757, "s":0.49144390248693526, "speed":0.033465145679656416},
                                                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                                                {"x":-45.85776302814484, "y":-68.73037984371186, "z":-82.35161495395005, "a":189.4134551100433, "s":1.22332091932185, "speed":0.04733489805366844},
                                                {"x":-69.16765234470368, "y":-23.417467069625857, "z":89.06063251197338, "a":347.57049431093037, "s":1.1883802893571556, "speed":0.06652093537850305},
                                                {"x":-55.92023830413819, "y":-34.82417807579041, "z":-98.08012987487018, "a":76.73200593329966, "s":1.161880531348288, "speed":0.008419372898060828},
                                                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                                        {"x":-14.803940343856812, "y":-2.0325098514556887, "z":93.1950946804136, "a":36.339591247960925, "s":0.9822242420632392, "speed":0.004517816822044551},
                                        {"x":18.61199817657471, "y":23.835578680038452, "z":-64.35827291570604, "a":118.3147793635726, "s":0.9796155944932252, "speed":0.11449461568845436},
                                        {"x":-22.095214772224427, "y":-15.608299565315248, "z":9.721252275630832, "a":150.2371311094612, "s":0.400591648183763, "speed":0.05115824168315157},
                                        {"x":-26.347469806671143, "y":14.884618949890138, "z":16.023369366303086, "a":328.15314933657646, "s":0.9963848264887929, "speed":0.14024699254659936},
                                        {"x":-5.461702299118042, "y":20.963383221626284, "z":40.82259479910135, "a":296.6026276163757, "s":0.49144390248693526, "speed":0.033465145679656416},
                                        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                                        {"x":-45.85776302814484, "y":-68.73037984371186, "z":-82.35161495395005, "a":189.4134551100433, "s":1.22332091932185, "speed":0.04733489805366844},
                                        {"x":-69.16765234470368, "y":-23.417467069625857, "z":89.06063251197338, "a":347.57049431093037, "s":1.1883802893571556, "speed":0.06652093537850305},
                                        {"x":-55.92023830413819, "y":-34.82417807579041, "z":-98.08012987487018, "a":76.73200593329966, "s":1.161880531348288, "speed":0.008419372898060828},
                                        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
                                {"x":-45.85776302814484, "y":-68.73037984371186, "z":-82.35161495395005, "a":189.4134551100433, "s":1.22332091932185, "speed":0.04733489805366844},
                                {"x":-69.16765234470368, "y":-23.417467069625857, "z":89.06063251197338, "a":347.57049431093037, "s":1.1883802893571556, "speed":0.06652093537850305},
                                {"x":-55.92023830413819, "y":-34.82417807579041, "z":-98.08012987487018, "a":76.73200593329966, "s":1.161880531348288, "speed":0.008419372898060828},
                                {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
        {"x":-33.855020713806155, "y":-40.72095963954926, "z":-72.59969678707421, "a":93.29257342033088, "s":0.46057135378941894, "speed":0.1089249642449431},
        {"x":-41.869017004966736, "y":-3.842224979400635, "z":-78.37993800640106, "a":190.76332532800734, "s":0.4358175948727876, "speed":0.11376933386782184},
        {"x":-56.701002311706546, "y":-33.271521067619325, "z":15.323592815548182, "a":171.03853683918715, "s":0.2987068241927773, "speed":0.09754157366696745},
        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
        {"x":0.27402820587158205, "y":-58.723335933685306, "z":-23.291093669831753, "a":141.12741949036717, "s":0.3658006521873176, "speed":0.050513550220057366},
        {"x":-66.81601839065551, "y":-8.668167662620545, "z":-9.931449824944139, "a":253.56346196494997, "s":0.5061084472108632, "speed":0.07752644213614986},
        {"x":-80.55151836872102, "y":-15.940375995635987, "z":-44.24448553472757, "a":169.56051788292825, "s":1.238750722259283, "speed":0.11593009295174851},
        {"x":-22.03183073997498, "y":6.696800565719605, "z":-72.67210576683283, "a":11.117333332076669, "s":0.411965572508052, "speed":0.07721009458182379},
        {"x":-37.919813299179076, "y":23.36127374172211, "z":-33.69748522527516, "a":269.5524160936475, "s":0.33488084957934916, "speed":0.14360593267483637},
        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
        {"x":0.13404448032379152, "y":30.211593747138977, "z":45.83982233889401, "a":173.5112074110657, "s":0.7269183634780347, "speed":0.11357735604979097},
        {"x":-47.57943196296692, "y":-11.3074205160141, "z":55.66919548436999, "a":221.04029674082994, "s":0.4986215594690293, "speed":0.14678188111865892},
        {"x":-15.085475730895997, "y":24.465509271621706, "z":-70.09053737856448, "a":160.59435733594, "s":0.46747914608567953, "speed":0.07555413575610145},
        {"x":-6.780279517173767, "y":-19.821271777153015, "z":-81.93132225424051, "a":69.87410341389477, "s":0.3763047957327217, "speed":0.04822931847302243},
        {"x":-11.970580434799196, "y":-23.49665668010712, "z":-95.91098977252841, "a":103.32832633517683, "s":0.6012711708899587, "speed":0.0323580517899245},
        {"x":-37.45892314910889, "y":-69.04529531002045, "z":-39.85684900544584, "a":189.8987471871078, "s":1.1885082218796015, "speed":0.026900742610450834},
        {"x":-21.01204290390015, "y":-56.17701437473298, "z":15.05298912525177, "a":327.7525459975004, "s":0.7133334521204233, "speed":0.0771445871097967},
        {"x":-50.236401891708375, "y":25.89903018474579, "z":33.12288583256304, "a":352.81981657259166, "s":0.6825355347245932, "speed":0.021899626858066765},
        {"x":-63.14862008094788, "y":-29.21197259426117, "z":-55.545232351869345, "a":158.00878839567304, "s":0.8182396467309445, "speed":0.027928515651728957},
        {"x":-20.01662201881409, "y":-62.825252532958984, "z":38.90356398187578, "a":105.41927288286388, "s":0.8784674699418247, "speed":0.10993520887568593},
        {"x":-40.52520623207093, "y":-28.956257224082947, "z":-23.275514179840684, "a":45.36313774064183, "s":0.9036676038522273, "speed":0.06641995935933664},
        {"x":-14.803940343856812,"y":-2.0325098514556887,"z":93.1950946804136,"a":36.339591247960925,"s":0.9822242420632392,"speed":0.004517816822044551},
        {"x":-23.095817184448244, "y":6.735561490058899, "z":-79.12749187089503, "a":7.941009113565087, "s":0.9819697090424597, "speed":0.07158474252792076},
        {"x":3.5132453203201295, "y":30.14545204639435, "z":-10.795052954927087, "a":182.0981367956847, "s":0.6604894590564072, "speed":0.1460788377095014},
        {"x":-12.361646866798402, "y":-41.05860719680786, "z":38.14920438453555, "a":62.18313418328762, "s":1.0646138575393707, "speed":0.01506748414831236},
        {"x":-53.28190214633942, "y":-8.071394920349121, "z":-86.47767985239625, "a":18.714714758098125, "s":0.6960710280109197, "speed":0.09332821512361988},
        {"x":-8.744031643867492, "y":10.630892562866212, "z":19.95812547393143, "a":270.8706187270582, "s":1.2066834005527198, "speed":0.0936253389227204},
        {"x":-23.252053928375247, "y":-6.954559946060181, "z":29.573117708787322, "a":22.625916386023164, "s":0.8477625353261828, "speed":0.014018386078532785},
        {"x":-6.394469404220581, "y":-59.2336984872818, "z":91.3529371842742, "a":164.57294242456555, "s":0.3655614568851888, "speed":0.06771082018967718},
        {"x":-8.49758415222168, "y":-39.32405121326447, "z":8.85220319032669, "a":290.615222286433, "s":0.45445317355915904, "speed":0.1360654663061723},
        {"x":-44.01844608783722, "y":16.185861730575564, "z":58.44803466461599, "a":165.92268515378237, "s":1.165628053015098, "speed":0.0410298753529787},
        {"x":1.3684559106826784, "y":-41.195962858200076, "z":82.56345116533339, "a":226.76415760070086, "s":0.9955828653182834, "speed":0.07454938996816053}
    ];

    for (var j = index * 10; j < index * 10 + 10; j++) {
        var cloud = document.createElement('img');
        cloud.style.opacity = 0;
        var r = Math.random();
        var src = 'http://www.clicktorelease.com/code/css3dclouds/cloud.png';
        if (Math.floor(r * 10) % 4 == 0) src = 'http://www.clicktorelease.com/code/css3dclouds/smoke.png';
        (function (img) {
            img.addEventListener('load', function () {
                img.style.opacity = .8;
            })
        })(cloud);
        cloud.setAttribute('src', src);
        cloud.className = 'cloudLayer';

        var x = datas[j].x;//100 - ( Math.random() * 512 );
        var y = datas[j].y;//156 - ( Math.random() * 512 );
        var z = datas[j].z;//100 - ( Math.random() * 200 );
        var a = datas[j].a*3;//Math.random() * 360;
        var s = datas[j].s;//.25 + Math.random();
        datas[j].speed *= 3;
        //x *= .2; y *= .2;
        cloud.data = datas[j];
        var t = 'translateX( ' + x + 'px ) translateY( ' + y + 'px ) translateZ( ' + z + 'px ) rotateZ( ' + a +
                'deg ) scale( ' + s + ' )';
        cloud.style.webkitTransform = t;
        cloud.style.MozTransform = t;
        cloud.style.oTransform = t;

        div.appendChild(cloud);
        layers.push(cloud);
    }

    return div;
}

window.addEventListener('mousewheel', onContainerMouseWheel);
//	window.addEventListener( 'DOMMouseScroll', onContainerMouseWheel );

//	window.addEventListener( 'mousemove', function( e ) {
//		worldYAngle = -( .5 - ( e.clientX / window.innerWidth ) ) * 180;
//		worldXAngle = ( .5 - ( e.clientY / window.innerHeight ) ) * 180;
//		updateView();
//	} );

function generate() {
    stopAnim = false;
    objects = [];
    if (world.hasChildNodes()) {
        while (world.childNodes.length >= 1) {
            world.removeChild(world.firstChild);
        }
    }

    var cloudData = [
        "translateX(-168.70525896549225px) translateY(176.30172455310822px) translateZ(-47.54599583148956px)",
        "translateX(32.6321153640747px) translateY(-31.06251680850983px) translateZ(193.52608478069305px)",
        "translateX(-40.50527667999268px) translateY(-148.13561236858368px) translateZ(-106.86783838272095px)",
        "translateX(18.27481067180634px) translateY(-144.44512581825256px) translateZ(-15.663189172744751px)",
        "translateX(-168.70525896549225px) translateY(176.30172455310822px) translateZ(-107.54599583148956px)",
        "translateX(-132.6321153640747px) translateY(-31.06251680850983px) translateZ(100.52608478069305px)",
        "translateX(-40.50527667999268px) translateY(-148.13561236858368px) translateZ(-36.86783838272095px)",
        "translateX(448.27481067180634px) translateY(-144.44512581825256px) translateZ(-65.663189172744751px)",
        "translateX(58.490150690078735px) translateY(52.47827064990997px) translateZ(59.58970272541046px)"];

    for (var j = 0; j < cloudData.length; j++) {
        objects.push(createCloud(cloudData[j], j));
    }

    updateView()
}

function updateView() {
    var t = 'translateZ( ' + d + 'px ) rotateX( ' + worldXAngle + 'deg) rotateY( ' + worldYAngle + 'deg)';
    world.style.webkitTransform = t;
    world.style.MozTransform = t;
    world.style.oTransform = t;
    requestAnimationFrame(updateView);
}

function onContainerMouseWheel(event) {

    event = event ? event : window.event;
    d = d - ( event.detail ? event.detail * -5 : event.wheelDelta / 8 );
    updateView();

}
var tt = 1.102;
function update() {
    if (tt > 1.003)
        tt = tt - 0.001;
    d = d * tt;
    for (var j = 0; j < layers.length; j++) {
        var layer = layers[ j ];
        layer.data.a += layer.data.speed;
        var t = 'translateX( ' + layer.data.x + 'px ) translateY( ' + layer.data.y + 'px ) translateZ( ' +
                layer.data.z + 'px ) rotateY( ' + ( -worldYAngle ) + 'deg ) rotateX( ' + ( -worldXAngle ) +
                'deg ) rotateZ( ' + layer.data.a + 'deg ) scale( ' + layer.data.s + ')';
        layer.style.webkitTransform = t;
        layer.style.MozTransform = t;
        layer.style.oTransform = t;
    }

    if (!stopAnim) requestAnimationFrame(update);

}

Reveal.addEventListener('intro', function() {
    generate();
    update();
    setTimeout(function() {
        stopAnim = true;
    }, 12000)
});


//update();
